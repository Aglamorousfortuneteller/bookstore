{% extends 'base.html' %}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}
{% block content %}
<h1>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>

{% if cart_items %}
<div style="display: flex; gap: 30px; align-items: flex-start;">

  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
  <div style="flex: 2;">
    <label>
      <input type="checkbox" id="select-all" onclick="
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedCount();
      "> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
    </label>
    <span id="selected-count" style="margin-left: 10px;">0 –≤—ã–±—Ä–∞–Ω–æ</span>

    <ul style="list-style: none; padding-left: 0;">
      {% for item in cart_items %}
      <li style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
        <input type="checkbox" class="item-checkbox" value="{{ item.id }}">
        <img src="https://media.istockphoto.com/id/162833278/nl/foto/blank-book.jpg?s=612x612&w=0&k=20&c=C-kb218UqFZ_ZdWg8ILDDcXDwpmYzwghnew_7VWZwm4=" style="width: 60px; border: 1px solid #ccc;">
        <div style="flex: 1;">
          <strong>{{ item.book.title }}</strong><br>
          –ê–≤—Ç–æ—Ä: {{ item.book.author }}<br>
          –ì–æ–¥: {{ item.book.year }}<br>
          –¶–µ–Ω–∞: {{ item.book.price }} ‚ÇΩ
        </div>
        <div>
          –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <a href="#" onclick="event.preventDefault(); changeQuantity({{ item.id }}, -1)">‚àí</a>
          <span id="qty-{{ item.id }}">{{ item.quantity }}</span>
          <a href="#" onclick="event.preventDefault(); changeQuantity({{ item.id }}, 1)">+</a>
        </div>
      </li>
      {% endfor %}
    </ul>

  </div>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
  <div style="flex: 1; border-left: 1px solid #ccc; padding-left: 20px;">
    <p><strong>–ò—Ç–æ–≥–æ:</strong> <span id="total-price">{{ "%.2f"|format(total) }} ‚ÇΩ</span></p>
    <form id="checkout-form" method="POST" action="{{ url_for('checkout') }}">
    <input type="hidden" name="selected_items" id="selected-items-input">
    <a href="#" onclick="submitCheckoutForm()" style="color: blue; text-decoration: underline; margin-top: 20px;">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
    </a>
    </form>

  </div>
</div>


{% else %}
<p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
{% endif %}

<a href="{{ url_for('index') }}" class="floating-back-button">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>


<!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ -->
<div id="delete-popup" style="display: none; position: fixed; top: 50%; left: 50%;
     transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #333; z-index: 1000;">
    <p style="font-weight: bold; margin-bottom: 15px;">–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?</p>
    <form id="delete-form" method="post">
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button type="submit" style="padding: 8px 15px; font-weight: bold;">–î–∞</button>
            <button type="button" onclick="closeDeletePopup()" style="padding: 8px 12px; font-weight: bold;">–ù–µ—Ç</button>
        </div>
    </form>
</div>


<script>

function changeQuantity(itemId, delta) {
  const qtySpan = document.getElementById('qty-' + itemId);
  let currentQty = parseInt(qtySpan.textContent);
  const newQty = currentQty + delta;

  if (newQty <= 0) {
    const deleteForm = document.getElementById('delete-form');
    deleteForm.action = `/cart/remove/${itemId}`;
    document.getElementById('delete-popup').style.display = 'block';
    return;
  }

  fetch(`/cart/update/${itemId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `quantity=${newQty}`
  }).then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    } else if (response.ok) {
      qtySpan.textContent = newQty;
      fetch('/cart/total')
        .then(res => res.json())
        .then(data => {
          document.getElementById('total-price').textContent = data.total + ' ‚ÇΩ';
        });
    } else {
      showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏", "error");
    }
  }).catch(err => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', err);
    showMessage("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
  });
}



function updateSelectedCount() {
  const selected = document.querySelectorAll('.item-checkbox:checked').length;
  document.getElementById('selected-count').textContent = `${selected} –≤—ã–±—Ä–∞–Ω–æ`;
}

document.addEventListener('DOMContentLoaded', function () {
  const checkboxes = document.querySelectorAll('.item-checkbox');
  checkboxes.forEach(cb => cb.addEventListener('change', updateSelectedCount));
  updateSelectedCount();
});

function proceedToCheckout() {
  const selectedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
  const formData = new FormData();
  selectedIds.forEach(id => formData.append('selected_items', id));
  fetch('{{ url_for("checkout") }}', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    } else {
      showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é", "error");
    }
  });
}

function submitCheckoutForm() {
  const selectedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
  if (selectedIds.length === 0) {
    const form = document.getElementById('checkout-form');
    form.innerHTML += '<input type="hidden" name="flash_error" value="1">';
    form.submit();
    return;
  }
  document.getElementById('selected-items-input').value = selectedIds.join(',');
  document.getElementById('checkout-form').submit();
}

function closeDeletePopup() {
  document.getElementById('delete-popup').style.display = 'none';
}

</script>


{% endblock %}
